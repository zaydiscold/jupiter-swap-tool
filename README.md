# Jupiter Swap Tool CLI (v1.1.3)

## Getting Started
1. Install Node.js 18+ **and** the Anchor CLI dependencies Jupiter Perps relies on (e.g. `cargo install --git https://github.com/coral-xyz/anchor anchor-cli` or follow [Anchor’s installation guide](https://www.anchor-lang.com/docs/installation)).
2. Clone the repo and run `npm install` to pull the JavaScript dependencies the CLI expects.
3. Double-click `run_cli_trader.command` (macOS) or run `node cli_trader.js` manually.
4. When prompted, supply your preferred RPC (or press Enter to use the default).
5. Open wallet tools with hotkey `1` to generate wallets or import existing ones (the `keypairs/` directory will be created automatically if it doesn't exist).
6. Use the hotkeys listed below to run funding, sweeping, swap, lend, or perps routines.

**Note**: The `keypairs/` directory is excluded from git and will be created automatically when you generate your first wallet.

Node/CLI tool for managing batches of Solana wallets, funding them, and copying swaps through Jupiter. This sheet lists the essentials so you can launch the script without digging into the source.

## Prerequisites
- Node.js 18+ (the launcher checks your PATH).
- Solana RPC URL (mainnet by default; pass devnet or a custom endpoint when prompted).
- Funded wallets stored in `keypairs/` as generated by the tool.
- Optional: populate `rpc_endpoints.txt` in this directory with newline-separated RPC URLs (e.g. public/rate-limited endpoints). The CLI will rotate through them automatically and temporarily sideline endpoints that come back with 401/403s or repeated rate-limit errors.

Environment variables (optional):

| Variable | Description |
| --- | --- |
| `RPC_URL` | Default RPC (overridden by the launcher prompt). |
| `RPC_LIST_FILE` | Path to a newline/CSV-separated list of RPC URLs to rotate through (defaults to `rpc_endpoints.txt` beside the CLI). |
| `RPC_HEALTH_URL` / `RPC_HEALTH_ENDPOINT` | Override the initial health check URL, bypassing rotation for the first probe. |
| `RPC_HEALTH_INDEX` | 1-based index into the loaded RPC list for the initial health check (handy when testing endpoints one-by-one). |
| `SWAP_AMOUNT_MODE` | Default swap behaviour (`all` or `random`); the launcher prompt sets this for you. |
| `JUPITER_SWAP_ENGINE` | Swap backend selector (`ultra` default, `lite` for the legacy quote/swap endpoints). |
| `JUPITER_ULTRA_API_KEY` | Jupiter Ultra API key (defaults to `91233f8d-d064-48c7-a97a-87b5d4d8a511`; override with your own credentials). |
| `JUPITER_ULTRA_API_BASE` | Override the Jupiter Ultra API base (defaults to `https://api.jup.ag/ultra/<JUPITER_ULTRA_API_KEY>` or `https://api.jup.ag/ultra/v1`). |
| `JUPITER_PRICE_API_BASE` | Override the default Price API v3 base (`https://api.jup.ag/price/v3`). |
| `JUPITER_TOKENS_API_BASE` | Override the default Tokens API v2 base (`https://api.jup.ag/tokens/v2`). |
| `JUPITER_LEND_API_BASE` | Override the Jupiter Lend Earn API base (defaults to `https://lite-api.jup.ag/lend/v1/earn`; the CLI auto-falls back to integrator paths if a 404 occurs). |
| `JUPITER_LEND_BORROW_API_BASE` | Override the Jupiter Lend Borrow API base (defaults to `https://lite-api.jup.ag/lend/v1/borrow`; the CLI auto-falls back to integrator paths if a 404 occurs). |
| `JUPITER_PERPS_API_BASE` | Override the Jupiter Perps API base (defaults to `https://perps-api.jup.ag` once the feature flag is enabled). |
| `PERPS_CONFIG_PATH` | Absolute or relative path to your `perps_config.json` file (defaults to `./perps_config.json` beside the CLI). |
| `PERPS_KEEPER_ONLY` | Set to `1` to skip direct order placement and only poll/fulfil keeper tasks from the config. |
| `PERPS_DRY_RUN` | Set to `1` to print perps payloads without submitting transactions (useful for sanity checks against staging). |
| `PRINT_SECRET_KEYS` | Set to `1` to print base58 secrets when generating wallets. |
| `GAS_RESERVE_LAMPORTS` | Lamports reserved for gas (default `1_000_000` ≈ 0.001 SOL). |
| `JUPITER_SOL_BUFFER_LAMPORTS` | Extra lamports left behind when spending SOL to cover wrap rent + Jupiter route side-costs (default `2_000_000`). |
| `JUPITER_SOL_RETRY_DELTA_LAMPORTS` | Lamports trimmed from the spending amount each time Jupiter reports “insufficient lamports” (default `200_000`). |
| `JUPITER_SOL_MAX_RETRIES` | Number of retries (with reduced spend) permitted before giving up on a wallet when Jupiter reports “insufficient lamports” (default `3`). |
| `SLIPPAGE_BPS` | Per-swap slippage tolerance in basis points (default `20`). |
| `MAX_SLIPPAGE_RETRIES` | Number of times to refetch routes when Jupiter reports a slippage failure (default `5`). |
| `MIN_SOL_PER_SWAP_LAMPORTS` | Minimum SOL a wallet must retain before SOL-based swaps are attempted (default `10_000_000`, ≈ 0.01 SOL). |
| `MIN_TRANSFER_LAMPORTS` | Smallest lamport transfer allowed in redistribution/aggregation (default `50_000`). |
| `ESTIMATED_GAS_PER_SWAP_LAMPORTS` | Estimated gas cost per swap transaction for multi-hop sequence planning (default `5_000`). |
| `ESTIMATED_ATA_CREATION_LAMPORTS` | Estimated cost for creating Associated Token Accounts (default `2_000_000`). |
| `NO_COLOR` | Set to `1` to disable colored console output. |
| `NODE_NO_WARNINGS` | Set to `1` to suppress Node deprecation noise (the launcher sets this automatically). |
| `JUPITER_SWAP_TOOL_TIMING` | Set to `1` to emit planning vs execution timings for Buckshot, Long Circle, BTC/ETH sweep, and perps loops. |

## Swap Engine
- Default: Ultra (`/ultra/.../order` → `/ultra/.../execute`). By default we target `https://api.jup.ag/ultra/91233f8d-d064-48c7-a97a-87b5d4d8a511`; override `JUPITER_ULTRA_API_KEY` if you have your own credentials. Ultra handles transaction dispatch (the CLI still confirms via your configured RPC for finality checks).
- Fallback: set `JUPITER_SWAP_ENGINE=lite` to use the legacy quote/swap endpoints (`/swap/v1/quote`, `/swap/v1/swap`).
- Override the base URL with `JUPITER_ULTRA_API_BASE` if you need to target staging.

## Current Workstream — Pre-Planned Execution
We are actively refactoring the highest-traffic commands to perform their heavy planning before any RPC calls. The goals are to minimise wallet-to-wallet latency and keep on-chain activity as the only bottleneck.

- **Buckshot mode** already pre-computes per-wallet token allocations before executing swaps.
- **Long circle** and **sweep-to-btc-eth** are next: expect upcoming changes that batch segment selection, gas estimates, and allocation weights ahead of execution.
- All planning utilities must remain pure (no side effects) so they can be reused across chains when adapters land.

See `ARCHITECTURE_PLAN.md` for the detailed roadmap and milestones.


## Upcoming — Jupiter Lend (Earn & Borrow)
Jupiter Lend will let you supply assets to earn passive yield or lock them as collateral and borrow. We plan to expose a dedicated CLI namespace that:

- Lists supported pools and live rates (`lend earn tokens`).
- Submits deposits/withdrawals/mint/redeem transactions (`lend earn deposit <mint> <amount>` etc.).
- Opens and maintains borrow positions (`lend borrow open <collateralMint> <borrowMint> <amount>`, plus adjust/repay/close helpers).

Implementation notes:

- Uses Jupiter Tokens API v2 and Price API v3 so health-factor, LTV, and yield projections rely on the newest endpoints.
- Runs planners ahead of time (no RPC requests) to batch wallet actions and surface instructions before execution.
- Prints confirmations that summarise withdrawal throttles, collateral ratios, and expected interest, followed by an explicit risk prompt.
- Adds env knobs like `JUPITER_LEND_API_BASE` / `JUPITER_LEND_BORROW_API_BASE` so you can point at staging endpoints as needed (automatic fallback from `/lend/...` to `/jup-integrators/...`).
- Reuses the timing helper (`JUPITER_SWAP_TOOL_TIMING=1`) so you can see planning vs execution cost.

Risk reminders (every command will reiterate these):

- **Smart-contract risk:** bugs can exist; never deposit more than you are willing to lose.
- **Market risk:** collateral values move; monitor your loan’s health to avoid liquidation.
- **Withdrawal throttles:** Earn withdrawals are rate-limited to protect pool health; limits refresh over time.
- **Borrow cost:** borrowers pay a variable interest rate and may incur liquidation penalties if health deteriorates.

You can experiment today from the CLI (`lend earn ...`, `lend borrow ...`) or from the launcher’s **Advanced → Jupiter Lend (beta)** menu. Responses are fully logged so you can inspect request IDs and raw payloads while the API stabilises.

Full design notes live in `ARCHITECTURE_PLAN.md` under “Jupiter Lend Integration”.


## Jupiter Perps (Beta)
The perps namespace mirrors Jupiter’s perpetual futures program and is guarded behind explicit config toggles so you can opt in deliberately.

- **Environment flags:** point `PERPS_CONFIG_PATH` to your perps configuration file (defaults to `./perps_config.json`) and set `JUPITER_PERPS_API_BASE` if you need to target staging. Use `PERPS_KEEPER_ONLY=1` to operate as a passive keeper and `PERPS_DRY_RUN=1` to print payloads without submitting them.
- **Config + usage:** copy `perps_config.sample.json` to `perps_config.json`, tailor the wallets/markets/leverage values, and keep the real file out of version control (it is now ignored via `.gitignore`). The CLI automatically loads this path when you run `perps …` commands.
- **Keeper workflow:** designate a keeper wallet in the config. `perps keeper fulfil` polls Jupiter’s keeper queue, filters work items against the config (tags, reduce-only exits, etc.), and submits them with the keeper wallet—freeing trading wallets from running 24/7. Combine the command with cron/systemd for continuous monitoring.
- **Reference material:** start with Jupiter’s [Perpetuals overview](https://station.jup.ag/docs/products/perpetuals/overview) and the [Keeper fulfilment guide](https://station.jup.ag/docs/products/perpetuals/keepers) to understand margin requirements, funding, and fulfilment responsibilities.

Every perps action prints the wallet’s maintenance margin, leverage, and liquidation band before submission. Treat the logs as required reading—leveraged positions carry material loss risk.


### RPC Rotation
If `rpc_endpoints.txt` sits next to `cli_trader.js`, the CLI will rotate through every non-empty URL in that file (one endpoint per line or comma-separated). The launcher-provided `RPC_URL` is always used first, and any duplicates are ignored. Rotation happens at connection time, so long-running commands naturally spread requests across the list. Set `RPC_LIST_FILE` to point at a different file if you want to keep multiple profiles.

## Launching
Double-click `run_cli_trader.command` (right-click → **Open** the first time to satisfy macOS Gatekeeper). The launcher:
1. Prompts for an RPC URL (press Enter for the default mainnet endpoint).
2. Asks whether swaps should default to `all` or `random` amounts (blank = `all`).
3. Displays hotkeys and keeps an interactive prompt open until you submit a blank line. After every command the hotkey list is reprinted automatically.
   The launcher banner now shows how many wallets are currently eligible for swaps (wallet guard counts) before the hotkey list.
   When you're done, type `CLOSE` (uppercase) at the final prompt to exit the launcher.

- `1` – wallet tools sub-menu (balances, wallet generation/import, wallet guard reset, address listing).
- `2` – force reset the wallet guard (clears the disabled-for-swaps list until balances runs again).
- `3` – redistribute SOL from `crew_1.json` evenly across all wallets.
- `4` – aggregate SOL from every wallet back into `crew_1.json`.
- `5` – reclaim SOL (close empty SPL/Token-2022 accounts and display the post-cleanup SOL balance when anything is reclaimed).
- `6` – swap SOL → USDC using the launcher's default amount mode.
- `7` – buckshot mode (spend an equal SOL slice into every long-circle token, then wait for you to paste new mint addresses to rotate those holdings).
- `8` – sweep every token balance into SOL (supports custom/unlisted mint addresses).
- `9` – advanced trade tools (target loop, long circle, RPC tester, crew_1 cycle, BTC/ETH sweep, SOL→USDC→POPCAT lap, and the prewritten Arpeggio/Horizon/Echo flows).

  Prewritten flow defaults:
  - **Arpeggio** – ≈15 minutes end-to-end with a 10–100 hop window (legs wait 2–4 min, 3–5 min, 4–6 min, then 2–4 min).
  - **Horizon** – ≈60 minutes of coverage with 50–300 hops (legs wait 8–12 min, 10–14 min, 12–18 min, 10–16 min, then 8–12 min).
  - **Echo** – ≈6 hours on target spanning 250–750 hops (legs wait 35–55 min, 45–75 min, 60–90 min, 55–95 min, 45–75 min, then 35–55 min).

  Launching them through the CLI honours `--loops`, `--duration-min`, `--duration`, and `--duration-max` so you can stretch or compress the schedule while the per-leg waits keep their random jitter inside the windows above.
- `0` – quit immediately.

Each swap hotkey expands to the equivalent `swap`/`swap-all` command so you still get full logging from `cli_trader.js`.

> On launch the CLI silently checks SOL balances and suppresses swap flows for any wallet holding under 0.01 SOL. Fund the wallet and rerun `balances` from the wallet tools menu (`1` → `1`) to refresh, or use hotkey `2` for a one-off force reset before the next automatic check.

> The CLI prints color-coded messages when running in a TTY. Set `NO_COLOR=1` before launching if you prefer plain text.

## Slippage
- Default slippage is 20 bps (0.20%). Override with `SLIPPAGE_BPS` if you need a higher tolerance.
- Jupiter errors with `slippage tolerance exceeded` trigger automatic retries (default 5).
- Jupiter sometimes waives fees for very large trades (> ~$1,110); the API handles that automatically when eligible.

## CLI Commands
Run these either from the launcher prompt or directly via `node cli_trader.js …`.

-**Perps safety note:** perpetuals are leveraged instruments. Always pre-fund the trading wallet with sufficient USDC collateral, double-check your leverage caps, and monitor liquidation thresholds printed by the CLI before placing orders.

- `generate <n> [prefix]` – create wallets (`prefix_1.json`, etc.). Use `PRINT_SECRET_KEYS=1` to print base58 secrets.
- `import-wallet --secret <secret> [--prefix name] [--path path] [--force]` – import an existing Solana keypair from base58, JSON, or mnemonic (default derivation path `m/44'/501'/0'/0'`).
- `list` – list all wallet filenames + public keys.
- `balances [tokenMint]` – show SOL plus any SPL tokens with non-zero balances, always printing requested mints and the default sweep list (USDC, POPCAT, PUMP, PENGU, FART, USELESS, WIF, PFP, wBTC, cbBTC, wETH) even when their balances are zero. Token-2022 accounts are displayed alongside legacy SPL. Running `balances` refreshes the wallet guard, disabling any wallet below 0.01 SOL for swap flows.
- `force-reset-wallets` – clear the wallet guard so every wallet can run swaps again until the next `balances` call recomputes statuses.
- `wallet-guard-status [--refresh]` – print the current guard summary (active/total/disabled). Pass `--refresh` to force an immediate balance check.
- `test-rpcs [all|index|match|url]` – probe one or more RPC endpoints (as listed in rotation) and report latency, version, and blockhash timings. Use a numeric index (1-based), a substring match, a full URL, or leave blank for all. Append `--swap --confirm` (optionally with `--loops N`, `--delay MS`, `--amount X`) to run an on-chain SOL→USDC→SOL stress test using `crew_1.json`.
- `test-ultra [inputMint] [outputMint] [amount] [--wallet name] [--submit]` – dry-run a Jupiter Ultra order (defaults to SOL→USDC, 0.001 SOL) to confirm the configured API key works. The transaction is decoded but not broadcast unless you include `--submit`, in which case it signs with the chosen wallet, sends via Ultra’s execute endpoint, and confirms on your active RPC.
- `fund-all <fromFile> <lamportsEach>` – send the same lamport amount from one wallet to all others.
- `redistribute <walletFile>` – evenly redistribute SOL from the chosen wallet across the whole set, leaving at least `GAS_RESERVE_LAMPORTS` and skipping dust transfers below `MIN_TRANSFER_LAMPORTS`.
- `fund <from> <to> <lamports>` / `send <from> <to> <lamports>` – simple SOL transfer between two local wallets.
- `aggregate <walletFile>` – sweep SOL from every other wallet back into the target (respecting gas reserve and minimum transfer).
- `airdrop <walletFile> <lamports>` – request a devnet airdrop for a single wallet.
- `airdrop-all <lamports>` – airdrop every wallet (devnet only).
- `swap <inputMint> <outputMint> [amount|all|random]` – Jupiter swap for each wallet; defaults to the Ultra order/execute flow. Set `JUPITER_SWAP_ENGINE=lite` to fall back to the legacy quote/swap endpoints. Omit the amount to use the session default (launcher prompt).
- `swap-all <inputMint> <outputMint>` – alias for `swap … all`.
- `swap-sol-to <mint> [amount|all|random]` – convenience alias for SOL→mint swaps.
- `buckshot` – spend an equal slice of SOL into every token in the long-circle rotation, then keep those positions open while prompting you for new mint addresses. Each new mint rotates all non-SOL balances into the target (up to 7 retries per hop, boosting slippage by +200 bps after the third attempt).
- `sol-usdc-popcat` – run SOL→USDC then USDC→POPCAT sequentially across every wallet (respects gas and rent reserves).
- `long-circle [extra|primary-only]` – run an extended multi-hop route that now includes SOL/USDC/POPCAT/PUMP/PENGU/FART/USELESS/WIF/PFP plus wBTC, cbBTC, and wETH. In `random` mode each wallet receives its own shuffled subset of segments and per-swap random amounts; deterministic runs execute the full cycle using whole balances. Pass `extra` to append an additional randomized SOL-out path (prompted automatically by the launcher).
- `sweep-to-btc-eth` – sweep every non-SOL holding back into SOL, then split the available SOL across wBTC, cbBTC, and wETH (respecting rent/gas guardrails and using per-wallet random weights when the session is in `random`).
- `reclaim-sol` – close all zero-balance associated token accounts for every wallet (legacy SPL + Token-2022). Accounts with withheld transfer fees remaining are skipped with an explanatory warning until the mint authority harvests the fees. Alias: `close-token-accounts`.
- `flow run <arpeggio|horizon|echo> [--loops N] [--duration-min 30m] [--duration 45m] [--duration-max 2h]` – execute a prewritten flow with the defaults above (Arpeggio ≈ 15 min/10–100 hops, Horizon ≈ 60 min/50–300 hops, Echo ≈ 6 hr/250–750 hops). Each leg samples a random wait inside its window (listed in the hotkey section) and overrides clamp to those bounds so custom durations keep the organic pacing while the hop target randomises within the advertised range.
- `lend earn …` / `lend borrow …` – interact with Jupiter Lend (Earn/Borrow beta). Examples: `lend earn tokens`, `lend earn deposit crew_1.json SOL 0.1`, `lend borrow open crew_1.json SOL USDC 1 0.5`. Passing `*` for the wallet, mint, or amount fans out across every active wallet, filters to eligible base assets/share tokens, and defaults to the maximum spendable balance (SOL keeps a rent/fee reserve automatically). Responses log status codes, request IDs, and payloads to help debug the still-beta endpoints. Use `lend borrow close <wallet> *` (or leave the launcher prompt blank) to close every borrow position for a wallet without hunting IDs. Deposits/withdrawals auto-submit returned transactions, auto-create missing ATAs, subtract a ~0.0022 SOL wrap buffer, and back off the deposit amount if the wallet is short on SOL; wallets with <0.005 SOL of headroom are skipped with guidance to top-up. Use `--no-send` to dry-run only.
- `lend overview` – pull earn positions, earnings, and borrow positions for every discovered wallet in a single call.
- `perps markets [--group <group>]` – list the perpetual markets Jupiter exposes for the selected group (defaults to `mainnet-beta`). Always confirm you have margin in a funded wallet before trading; liquidations can eat the full deposit.
- `perps positions [wallet|*]` – print open positions and account health for one wallet or every configured wallet. The `*` wildcard fans across all wallets that appear in your perps config.
- `perps open <wallet> <market> <long|short> <size>` – place a new perp order with optional flags like `--leverage <x>`, `--reduce-only`, or `--tag <label>`. The CLI enforces margin fraction thresholds from your config and refuses to submit if the wallet is underfunded.
- `perps close <wallet> <market> [amount|all]` – reduce or fully close an existing position. Use `--reduce-only` for hedge adjustments and `--dry-run` (or `PERPS_DRY_RUN=1`) to preview the transaction payload.
- `perps keeper fulfil [--path <config>] [--tag <label>]` – load `perps_config.json`, scan for orders that require off-chain keeper fulfilment (reduce-only exits, take-profit triggers, etc.), and submit them using the designated keeper wallet. Combine with `PERPS_KEEPER_ONLY=1` to run passive monitoring without direct trading commands.
- `tokens --refresh` – force-refresh the token catalog via Jupiter Tokens API v2 before printing (fallback/local entries remain merged in).

### Prewritten flows

Automation presets (for example the Arpeggio rotation) are backed by `runPrewrittenFlow`. Each flow owns a runtime profile that advertises both its coverage target (≈15 min, ≈60 min, ≈6 hr) and the hop window it randomises across (10–100, 50–300, 250–750). A sampled hop target is converted into whole cycles—trimming the final cycle when necessary—and the per-flow minimum guarantees the run doesn’t look abnormally short while still allowing shorter targets to complete once their stopovers finish. The requested session duration is partitioned into random per-hop waits so the cumulative pause budget stays close to the operator’s target while still injecting jitter between swaps.

All swap commands print:
- Input/output mint metadata (program ID + decimals).
- Chosen amount per wallet plus SOL/token balance deltas after every confirmed swap (makes P/L obvious).
- Jupiter logs if a simulation fails (handy for Token-2022 edge cases on devnet). Simulation retries now include automatic slippage boosts on the third attempt and quote backoff when rate limits arise.

## Known Mints Cache
The CLI preloads metadata for every token used in the built-in routes so swaps still work even if the RPC rate-limits metadata calls:
- SOL native (`So11111111111111111111111111111111111111112`).
- USDC mainnet (`EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`).
- POPCAT (`7GCihgDB8fe6KNjn2MYtkzZcRjQy3t9GHdC8uHYmW2hr`).
- PUMP (`pumpCmXqMfrsAkQ5r49WcJnRayYRqmXz6ae8H7H9Dfn`).
- PENGU (`2zMMhcVQEXDtdE6vsFS7S7D5oUodfJHE8vd1gnBouauv`).
- FART (`9BB6NFEcjBCtnNLFko2FqVQBq8HHM13kCyYcdQbgpump`).
- USELESS (`Dz9mQ9NzkBcCsuGPFJ3r1bS4wgqKMHBPiVuniW8Mbonk`).
- WIF (`EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm`).
- PFP (`5TfqNKZbn9AnNtzq8bbkyhKgcPGTfNDc9wNzFrTBpump`).
- wBTC (`3NZ9JMVBmGAqocybic2c7LQCJScmgsAZ6vQqTDzcqmJh`).
- cbBTC (`cbbtcf3aa214zXHbiAZQwf4122FBYbraNdFqgw4iMij`).
- wETH (`7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs`).

Additional tokens (including any custom mints you supply to the CLI) are cached automatically at runtime; add them permanently by extending `KNOWN_MINTS` in `cli_trader.js` if you want to avoid the first-lookup RPC hit.

## Testing With Small Amounts
- Swaps accept decimals (e.g. `swap So111… EPjF… 0.005`). The CLI converts to lamports and ensures the wallet still keeps the configured gas reserve.
- Redistribution/aggregation refuse transfers smaller than `MIN_TRANSFER_LAMPORTS` to avoid wasting fees; adjust the env var if you need finer granularity.
- If a transaction fails, read the printed Jupiter logs—common devnet issues include Token‑2022 mint restrictions or missing ATAs.

## Tip
Keep backups of the generated `keypairs/*.json` files. The launcher never touches them except to read secret keys for signing.
