# Jupiter Swap Tool CLI (v1.0.2)

## Getting Started
1. Install Node.js 18+ and clone the repo.
2. Double-click `run_cli_trader.command` (macOS) or run `node cli_trader.js` manually.
3. When prompted, supply your preferred RPC (or press Enter to use the default).
4. Open wallet tools with hotkey `1` to generate wallets or import existing ones (the `keypairs/` directory will be created automatically if it doesn't exist).
5. Use the hotkeys listed below to run funding, sweeping, or swap routines.

**Note**: The `keypairs/` directory is excluded from git and will be created automatically when you generate your first wallet.

Node/CLI tool for managing batches of Solana wallets, funding them, and copying swaps through Jupiter. This sheet lists the essentials so you can launch the script without digging into the source.

## Prerequisites
- Node.js 18+ (the launcher checks your PATH).
- Solana RPC URL (mainnet by default; pass devnet or a custom endpoint when prompted).
- Funded wallets stored in `keypairs/` as generated by the tool.
- Optional: populate `rpc_endpoints.txt` in this directory with newline-separated RPC URLs (e.g. public/rate-limited endpoints). The CLI will rotate through them automatically and temporarily sideline endpoints that come back with 401/403s or repeated rate-limit errors.

Environment variables (optional):
- `RPC_URL` – default RPC (overridden by launcher prompt).
- `JUPITER_API` – custom Jupiter endpoint.
- `RPC_LIST_FILE` – optional path to a newline/CSV-separated list of RPC URLs to rotate through (default `rpc_endpoints.txt` in the project root).
- `RPC_HEALTH_URL` (or `RPC_HEALTH_ENDPOINT`) – force the initial health check to use a specific RPC URL instead of the current rotation.
- `RPC_HEALTH_INDEX` – 1-based index into the loaded RPC list for the initial health check (handy when testing endpoints one-by-one).
- `SWAP_AMOUNT_MODE` – default swap behaviour (`all` or `random`); the launcher prompt sets this for you.
- `PRINT_SECRET_KEYS=1` – print base58 secrets when generating wallets.
- `GAS_RESERVE_LAMPORTS` – lamports reserved for gas (default `1_000_000` ≈ 0.001 SOL).
- `JUPITER_SOL_BUFFER_LAMPORTS` – extra lamports left behind when spending SOL to cover wrap rent + Jupiter route side-costs (default `2_000_000`).
- `JUPITER_SOL_RETRY_DELTA_LAMPORTS` – lamports trimmed from the spending amount each time Jupiter reports "insufficient lamports" (default `200_000`).
- `JUPITER_SOL_MAX_RETRIES` – number of retries (with reduced spend) permitted before giving up on a wallet when Jupiter reports "insufficient lamports" (default `3`).
- `SLIPPAGE_BPS` – per-swap slippage tolerance in basis points (default `20`).
- `MAX_SLIPPAGE_RETRIES` – number of times to refetch routes when Jupiter reports a slippage failure (default `5`).
- `MIN_SOL_PER_SWAP_LAMPORTS` – minimum SOL a wallet must retain before SOL-based swaps are attempted (default `10_000_000`, ≈ 0.01 SOL, to leave room for rent and fees).
- `MIN_TRANSFER_LAMPORTS` – smallest lamport transfer allowed in redistribution/aggregation (default `50_000`).
- `ESTIMATED_GAS_PER_SWAP_LAMPORTS` – estimated gas cost per swap transaction for multi-hop sequence planning (default `5_000`).
- `ESTIMATED_ATA_CREATION_LAMPORTS` – estimated cost for creating Associated Token Accounts (default `2_000_000`).
- `NO_COLOR=1` – disable colored console output.
- `NODE_NO_WARNINGS=1` – suppress Node deprecation noise (launcher sets this automatically).


### RPC Rotation
If `rpc_endpoints.txt` sits next to `cli_trader.js`, the CLI will rotate through every non-empty URL in that file (one endpoint per line or comma-separated). The launcher-provided `RPC_URL` is always used first, and any duplicates are ignored. Rotation happens at connection time, so long-running commands naturally spread requests across the list. Set `RPC_LIST_FILE` to point at a different file if you want to keep multiple profiles.

## Launching
Double-click `run_cli_trader.command` (right-click → **Open** the first time to satisfy macOS Gatekeeper). The launcher:
1. Prompts for an RPC URL (press Enter for the default mainnet endpoint).
2. Asks whether swaps should default to `all` or `random` amounts (blank = `all`).
3. Displays hotkeys and keeps an interactive prompt open until you submit a blank line. After every command the hotkey list is reprinted automatically.
   The launcher banner now shows how many wallets are currently eligible for swaps (wallet guard counts) before the hotkey list.
   When you're done, type `CLOSE` (uppercase) at the final prompt to exit the launcher.

- `1` – wallet tools sub-menu (balances, wallet generation/import, wallet guard reset, address listing).
- `2` – force reset the wallet guard (clears the disabled-for-swaps list until balances runs again).
- `3` – redistribute SOL from `crew_1.json` evenly across all wallets.
- `4` – aggregate SOL from every wallet back into `crew_1.json`.
- `5` – reclaim SOL (close empty SPL/Token-2022 accounts and display the post-cleanup SOL balance when anything is reclaimed).
- `6` – swap SOL → USDC using the launcher's default amount mode.
- `7` – buckshot mode (spend an equal SOL slice into every long-circle token, then wait for you to paste new mint addresses to rotate those holdings).
- `8` – sweep every token balance into SOL (supports custom/unlisted mint addresses).
- `9` – advanced trade tools (target loop, long circle, RPC tester, crew_1 cycle, BTC/ETH sweep, SOL→USDC→POPCAT lap).
- `0` – quit immediately.

Each swap hotkey expands to the equivalent `swap`/`swap-all` command so you still get full logging from `cli_trader.js`.

> On launch the CLI silently checks SOL balances and suppresses swap flows for any wallet holding under 0.01 SOL. Fund the wallet and rerun `balances` from the wallet tools menu (`1` → `1`) to refresh, or use hotkey `2` for a one-off force reset before the next automatic check.

> The CLI prints color-coded messages when running in a TTY. Set `NO_COLOR=1` before launching if you prefer plain text.

## Slippage
- Default slippage is 20 bps (0.20%). Override with `SLIPPAGE_BPS` if you need a higher tolerance.
- Jupiter errors with `slippage tolerance exceeded` trigger automatic retries (default 5).
- Jupiter sometimes waives fees for very large trades (> ~$1,110); the API handles that automatically when eligible.

## CLI Commands
Run these either from the launcher prompt or directly via `node cli_trader.js …`.

- `generate <n> [prefix]` – create wallets (`prefix_1.json`, etc.). Use `PRINT_SECRET_KEYS=1` to print base58 secrets.
- `import-wallet --secret <secret> [--prefix name] [--path path] [--force]` – import an existing Solana keypair from base58, JSON, or mnemonic (default derivation path `m/44'/501'/0'/0'`).
- `list` – list all wallet filenames + public keys.
- `balances [tokenMint]` – show SOL plus any SPL tokens with non-zero balances, always printing requested mints and the default sweep list (USDC, POPCAT, PUMP, PENGU, FART, USELESS, WIF, PFP, wBTC, cbBTC, wETH) even when their balances are zero. Token-2022 accounts are displayed alongside legacy SPL. Running `balances` refreshes the wallet guard, disabling any wallet below 0.01 SOL for swap flows.
- `force-reset-wallets` – clear the wallet guard so every wallet can run swaps again until the next `balances` call recomputes statuses.
- `wallet-guard-status [--refresh]` – print the current guard summary (active/total/disabled). Pass `--refresh` to force an immediate balance check.
- `test-rpcs [all|index|match|url]` – probe one or more RPC endpoints (as listed in rotation) and report latency, version, and blockhash timings. Use a numeric index (1-based), a substring match, a full URL, or leave blank for all. Append `--swap --confirm` (optionally with `--loops N`, `--delay MS`, `--amount X`) to run an on-chain SOL→USDC→SOL stress test using `crew_1.json`.
- `fund-all <fromFile> <lamportsEach>` – send the same lamport amount from one wallet to all others.
- `redistribute <walletFile>` – evenly redistribute SOL from the chosen wallet across the whole set, leaving at least `GAS_RESERVE_LAMPORTS` and skipping dust transfers below `MIN_TRANSFER_LAMPORTS`.
- `fund <from> <to> <lamports>` / `send <from> <to> <lamports>` – simple SOL transfer between two local wallets.
- `aggregate <walletFile>` – sweep SOL from every other wallet back into the target (respecting gas reserve and minimum transfer).
- `airdrop <walletFile> <lamports>` – request a devnet airdrop for a single wallet.
- `airdrop-all <lamports>` – airdrop every wallet (devnet only).
- `swap <inputMint> <outputMint> [amount|all|random]` – Jupiter swap for each wallet; omit the amount to use the session default (launcher prompt).
- `swap-all <inputMint> <outputMint>` – alias for `swap … all`.
- `swap-sol-to <mint> [amount|all|random]` – convenience alias for SOL→mint swaps.
- `buckshot` – spend an equal slice of SOL into every token in the long-circle rotation, then keep those positions open while prompting you for new mint addresses. Each new mint rotates all non-SOL balances into the target (up to 7 retries per hop, boosting slippage by +200 bps after the third attempt).
- `sol-usdc-popcat` – run SOL→USDC then USDC→POPCAT sequentially across every wallet (respects gas and rent reserves).
- `long-circle [extra|primary-only]` – run an extended multi-hop route that now includes SOL/USDC/POPCAT/PUMP/PENGU/FART/USELESS/WIF/PFP plus wBTC, cbBTC, and wETH. In `random` mode each wallet receives its own shuffled subset of segments and per-swap random amounts; deterministic runs execute the full cycle using whole balances. Pass `extra` to append an additional randomized SOL-out path (prompted automatically by the launcher).
- `sweep-to-btc-eth` – sweep every non-SOL holding back into SOL, then split the available SOL across wBTC, cbBTC, and wETH (respecting rent/gas guardrails and using per-wallet random weights when the session is in `random`).
- `reclaim-sol` – close all zero-balance associated token accounts for every wallet (legacy SPL + Token-2022). Accounts with withheld transfer fees remaining are skipped with an explanatory warning until the mint authority harvests the fees. Alias: `close-token-accounts`.

All swap commands print:
- Input/output mint metadata (program ID + decimals).
- Chosen amount per wallet plus SOL/token balance deltas after every confirmed swap (makes P/L obvious).
- Jupiter logs if a simulation fails (handy for Token-2022 edge cases on devnet). Simulation retries now include automatic slippage boosts on the third attempt and quote backoff when rate limits arise.

## Known Mints Cache
The CLI preloads metadata for every token used in the built-in routes so swaps still work even if the RPC rate-limits metadata calls:
- SOL native (`So11111111111111111111111111111111111111112`).
- USDC mainnet (`EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`).
- POPCAT (`7GCihgDB8fe6KNjn2MYtkzZcRjQy3t9GHdC8uHYmW2hr`).
- PUMP (`pumpCmXqMfrsAkQ5r49WcJnRayYRqmXz6ae8H7H9Dfn`).
- PENGU (`2zMMhcVQEXDtdE6vsFS7S7D5oUodfJHE8vd1gnBouauv`).
- FART (`9BB6NFEcjBCtnNLFko2FqVQBq8HHM13kCyYcdQbgpump`).
- USELESS (`Dz9mQ9NzkBcCsuGPFJ3r1bS4wgqKMHBPiVuniW8Mbonk`).
- WIF (`EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm`).
- PFP (`5TfqNKZbn9AnNtzq8bbkyhKgcPGTfNDc9wNzFrTBpump`).
- wBTC (`3NZ9JMVBmGAqocybic2c7LQCJScmgsAZ6vQqTDzcqmJh`).
- cbBTC (`cbbtcf3aa214zXHbiAZQwf4122FBYbraNdFqgw4iMij`).
- wETH (`7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs`).

Additional tokens (including any custom mints you supply to the CLI) are cached automatically at runtime; add them permanently by extending `KNOWN_MINTS` in `cli_trader.js` if you want to avoid the first-lookup RPC hit.

## Testing With Small Amounts
- Swaps accept decimals (e.g. `swap So111… EPjF… 0.005`). The CLI converts to lamports and ensures the wallet still keeps the configured gas reserve.
- Redistribution/aggregation refuse transfers smaller than `MIN_TRANSFER_LAMPORTS` to avoid wasting fees; adjust the env var if you need finer granularity.
- If a transaction fails, read the printed Jupiter logs—common devnet issues include Token‑2022 mint restrictions or missing ATAs.

## Tip
Keep backups of the generated `keypairs/*.json` files. The launcher never touches them except to read secret keys for signing.
