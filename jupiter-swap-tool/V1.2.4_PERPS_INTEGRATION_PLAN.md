# v1.2.4 Jupiter Perps Integration Plan

## Current State (v1.2.3)
✅ **Backend Infrastructure Complete**:
- `perps.js` - Full Anchor program integration with Jupiter Perps IDL
- `perps/` folder - Client, data, utils modules
- CLI commands exist: `perps markets`, `perps positions`, `perps open`, `perps close`
- API integration working with lite endpoints

❌ **Missing UI Integration**:
- No launcher menu hotkeys for perps
- Not visible in main interactive CLI
- Users must know exact commands

## v1.2.4 Goals: Add Perps to Launcher Menu

### 1. Add Perps Menu Section
Location: Main launcher hotkey context

```
Perps Trading:
  'p' / 'perps'     Open perps trading menu
```

### 2. Perps Submenu Structure
```
Jupiter Perps Menu:
  '1'  View available markets (SOL-PERP, BTC-PERP, ETH-PERP, etc.)
  '2'  View open positions (all wallets)
  '3'  Open long position
  '4'  Open short position
  '5'  Close position
  '6'  Close all positions
  'b'  Back to main menu
```

### 3. Workflow Examples

#### Open Position Flow:
1. User presses 'p' → Perps menu
2. Presses '3' → Open long
3. Prompts:
   - Select market (SOL-PERP, ETH-PERP, BTC-PERP)
   - Select wallet(s) or "all"
   - Enter size (SOL amount)
   - Enter leverage (1-100x)
4. Confirmation screen with costs
5. Execute transaction

#### View Positions Flow:
1. User presses 'p' → Perps menu
2. Presses '2' → View positions
3. Shows table:
```
Wallet      Market      Side   Size    Entry    Current   PnL      Leverage
crew_1      SOL-PERP    LONG   0.5 SOL $150.00  $152.00   +$1.00   5x
crew_5      ETH-PERP    SHORT  0.3 SOL $3200    $3180     +$6.00   10x
```

### 4. Implementation Tasks

#### Phase 1: Menu Structure
- [ ] Add perps hotkey group to HOTKEY_GROUPS
- [ ] Create perps submenu handler
- [ ] Wire up navigation (main → perps → back)

#### Phase 2: View Functions (Read-Only)
- [ ] `viewPerpsMarkets()` - Display available markets with current prices
- [ ] `viewPerpsPositions()` - Display all open positions across wallets
- [ ] Add color-coded PnL (green positive, red negative)

#### Phase 3: Trading Functions (Write Operations)
- [ ] `openPerpsPosition()` - Interactive position opening
  - Market selection dropdown
  - Wallet selection (support wildcards like lend)
  - Size input with SOL balance validation
  - Leverage slider (1-100x)
  - Slippage protection
- [ ] `closePerpsPosition()` - Close specific position by index
- [ ] `closeAllPerpsPositions()` - Emergency close all

#### Phase 4: Safety & Validation
- [ ] Minimum collateral checks (prevent liquidation)
- [ ] Leverage limits per market
- [ ] Position size limits
- [ ] Confirmation prompts for all trades
- [ ] Dry-run mode (preview without execution)

### 5. Configuration
Add to `.env` or config:
```bash
# Perps defaults
PERPS_DEFAULT_LEVERAGE=5
PERPS_MAX_LEVERAGE=20
PERPS_MIN_COLLATERAL_SOL=0.1
PERPS_SLIPPAGE_BPS=50  # 0.5%
```

### 6. Error Handling
- Insufficient collateral → Show required amount
- Market closed → Show available markets
- Position not found → List all positions
- RPC failures → Auto-retry with fallback

### 7. Reference Implementation
Source: https://github.com/julianfssen/jupiter-perps-anchor-idl-parsing

Key examples to integrate:
- `src/examples/fetch-pool.ts` - Pool data fetching
- `src/examples/fetch-positions.ts` - Position queries
- `src/examples/increase-position.ts` - Open/increase positions
- `src/examples/close-position.ts` - Close positions

### 8. Testing Checklist
- [ ] View markets without API key
- [ ] Open position with single wallet
- [ ] Open position with multiple wallets
- [ ] Close position successfully
- [ ] Handle insufficient balance
- [ ] Handle invalid leverage
- [ ] Dry-run all operations
- [ ] Verify PnL calculations

### 9. Documentation Updates
- [ ] Add perps section to README.md
- [ ] Update CLAUDE.md with perps integration notes
- [ ] Create `docs/PERPS_GUIDE.md` with examples
- [ ] Add perps commands to `docs/cli-commands.txt`

### 10. Changelog Entry (v1.2.4)
```markdown
## [1.2.4] - 2025-11-XX

### Added
- **Jupiter Perps Integration**: Full launcher menu integration for perpetual trading
  - View markets with real-time prices
  - View all open positions across wallets
  - Open long/short positions with leverage
  - Close positions individually or in bulk
  - Interactive prompts with safety validations
- **Perps Safety Features**: Minimum collateral checks, leverage limits, dry-run mode

### Changed
- Perps now accessible via 'p' hotkey in main launcher menu
```

## Next Steps for v1.2.4
1. Start with Phase 1 (menu structure) - low risk, pure UI
2. Add Phase 2 (read-only views) - safe, no transactions
3. Implement Phase 3 (trading) with extensive safety checks
4. Full testing on devnet before mainnet deployment

**Estimated Effort**: 2-3 days for full integration with testing
